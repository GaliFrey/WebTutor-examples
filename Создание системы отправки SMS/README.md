# Настройка отправки СМС через систему WebTutor

## Содержание

* [Описание разработки](#Описание-разработки)
* [Регистрация во внешней системы SMS](#Регистрация-во-внешней-системы-SMS)
* [Создание системы SMS уведомлений в WebTutor](#Создание-системы-SMS-уведомлений-в-WebTutor)
* [Написание библиотеки для отправки SMS](#Написание-библиотеки-для-отправки-SMS)
* [Пример отправки](#Пример-отправки)

## Описание разработки

Для создания и формирования самого сообщения будет использоваться стандартный функционал. Создается тип уведомления, создается шаблон уведомления, отправка генерируется стандартными средствами или через функцию `tools.create_notification`. В типе уведомлений используем созданную систему уведомлений SMS.

Сама система отправки уведомлений начинает действовать после того, как создается неотправленное уведомление. Далее, с какой-то периодичностью, запускается скрипт, который обрабатывает созданные сообщения. Так работает стандартная отправка по Email и так будет работать наша отправка SMS.

В данной разработке будет использоваться сервис отправки SMS "Prostor SMS". Стандартная регистрация. В разработке будут использоваться полученные логин и пароль для авторизации.

## Регистрация во внешней системы SMS

Регистрируемся на сайте [Простор СМС](https://prostor-sms.ru/).

Нам понадобятся полученные логин и пароль.

## Создание системы SMS уведомлений в WebTutor

Открываем Администратор WT, переходим в блок `Дизайнер`, пункт меню `Системы уведомлений`.

![system_notification](img/system_notification.png)

Создаем новую запись и заполняем карточку

![](img/sms_system_notification.png)

* **Код** - на наше усмотрение
* **Название** - на наше усмотрение
* **Ссылка на файл библиотеки** - это наш скрипт, который будет обрабатывать и отправлять SMS

##### Параметры:
* **sServiceUrl** - указываем адрес API. Для отправки запросов мы будем использовать метод `JSON`. Мы будем использовать адрес `http://api.prostor-sms.ru/messages/v2/send.json`
* **sUSer** - логин, полученный при регистрации в системе "Prostor SMS"
* **sPassword** - пароль, полученный при регистрации в системе "Prostor SMS"
* **sSendName** - короткое наименование, отправитель SMS

## Написание библиотеки для отправки SMS

Библиотека будет написана по аналогии стандартной библиотеки, той, что используется для отправки Email. Название функции в библиотеке должно строго соответствовать стандартной и называться **SendNotification**. Так же, функция должна возвращать объект с результатом отправки для вывода результата в лог **email**.

Код библиотеки для отправки SMS можно посмотреть в файле [lib_notification_system_prostor_sms.js](lib_notification_system_prostor_sms.js)

Этот файл нужно скопировать, или создать свой, и поместить точно по тому пути, который указан в нашей карточке системы уведомлений.

![](img/lib_link.png)

## Пример отправки

Для отправки уведомления создадим шаблон уведомления. Заполним тестовыми данными и будем использовать тип HTML, а так же используем программный код
![](img/template_notification.png)

Создадим тип уведомления для отправки нашего шаблона. В качестве системы уведомлений используем наш SMS
![](img/type_notification.png)

Для запуска процесса отправки используем агент с выполняемым кодом
![](img/server_agent.png)

Запускаем агент на стороне сервера и наблюдаем за движением нашего уведомления:

1. Появление в разделе **Неотправленные уведомления**  
![](img/stage1.png)
2. В карточке уведомления все стандартно, поле с мобильным номером не заполнено  
![](img/stage2.png)
3. После обработки уведомления его статус изменился на **Отправлен**  
![](img/stage3.png)
4. В карточке уведомления изменился статус, появился номер телефона для получателя, тип сообщения сменился на текст.  
![](img/stage4.png)
5. В логе **email** видим соответствующее сообщение  
![](img/stage5.png)
